WITH expense as
(SELECT EXPENSE_DATE,
    SUM(TECH_TOOL_EXPENSE) as TECH_TOOL_EXPENSE,
    SUM(HR_EXPENSE) as HR_EXPENSE,
    SUM(WAREHOUSE_EXPENSE) as WAREHOUSE_EXPENSE,
    SUM(OTHER_EXPENSE) as OTHER_EXPENSE
FROM (SELECT DATE as EXPENSE_DATE,
    CASE WHEN EXPENSE_TYPE = 'tech tool' THEN EXPENSE_AMOUNT ELSE 0 END AS TECH_TOOL_EXPENSE,
    CASE WHEN EXPENSE_TYPE = 'hr' THEN EXPENSE_AMOUNT ELSE 0 END AS HR_EXPENSE,
    CASE WHEN EXPENSE_TYPE = 'warehouse' THEN EXPENSE_AMOUNT ELSE 0 END AS WAREHOUSE_EXPENSE,
    CASE WHEN EXPENSE_TYPE = 'other' THEN EXPENSE_AMOUNT ELSE 0 END AS OTHER_EXPENSE,
FROM {{ ref('base_google_drive__expenses') }}) as t
GROUP BY 1),

refund as
(SELECT RETURNED_DATE as REFUND_DATE,
    SUM(TOTAL_PRICE) as REFUND_COST,
FROM {{ ref('int_orders') }}
WHERE IS_REFUNDED = 1
GROUP BY 1),

revenue as
(SELECT DATE(ORDER_AT_TS) as ORDER_DATE,
    SUM(TOTAL_PRICE) as REVENUE,
    SUM(SHIPPING_COST) as SHIPPING_COST,
    SUM(TOTAL_PRICE*TAX_RATE) as TAX
FROM {{ ref('int_orders') }}
GROUP BY 1),

date_window as
(SELECT DATE
FROM {{ ref('base_google_drive__expenses') }} as t
GROUP BY 1
ORDER BY 1),

salary as
(SELECT SALARY_DATE,
    SUM(SALARY) as SALARY
FROM
    (SELECT DATE as SALARY_DATE,
        COALESCE(SUM(ANNUAL_SALARY)/365,0) as SALARY
    FROM (SELECT *
        FROM date_window as dw
        LEFT JOIN {{ ref('int_employee') }} as ep
        ON dw.DATE >= ep.HIRE_DATE
        AND ep.QUIT_DATE IS NULL
        ORDER BY DATE) as t
    GROUP BY 1
    
    UNION
    
    SELECT DATE as SALARY_DATE,
        COALESCE(SUM(ANNUAL_SALARY)/365,0) as SALARY
    FROM (SELECT *
        FROM date_window as dw
        LEFT JOIN {{ ref('int_employee') }} as ep
        ON dw.DATE >= ep.HIRE_DATE
        AND ep.QUIT_DATE >= dw.DATE
        ORDER BY DATE) as t
    GROUP BY 1) as t
GROUP BY 1)


SELECT expense.EXPENSE_DATE as FINANCE_DATE,
    COALESCE(REVENUE, 0) AS REVENUE,
    COALESCE(TECH_TOOL_EXPENSE, 0) AS TECH_TOOL_EXPENSE,
    COALESCE(HR_EXPENSE, 0) AS HR_EXPENSE,
    COALESCE(WAREHOUSE_EXPENSE, 0) AS WAREHOUSE_EXPENSE,
    COALESCE(OTHER_EXPENSE, 0) AS OTHER_EXPENSE,
    COALESCE(REFUND_COST, 0) AS REFUND_COST,
    COALESCE(SALARY, 0) AS SALARY,
    COALESCE(SHIPPING_COST, 0) AS SHIPPING_COST,
    COALESCE(TAX, 0) AS TAX
FROM expense
LEFT JOIN refund
ON expense.EXPENSE_DATE = refund.REFUND_DATE
LEFT JOIN revenue
ON expense.EXPENSE_DATE = revenue.ORDER_DATE
LEFT JOIN salary
ON expense.EXPENSE_DATE = salary.SALARY_DATE
ORDER BY 1